name: Build

on:
  workflow_call:
    inputs:
      wheel-name-pattern:
        description: 'Pattern to match wheel files for upload (e.g., "package_name-*.whl")'
        type: string
        required: true
      pure-python:
        description: 'Whether this is a pure Python package (no compilation needed)'
        type: boolean
        default: false
        required: false
      package-dir:
        description: 'Path to package directory'
        type: string
        default: '.'
        required: false
      output-dir:
        description: 'Path to output directory for wheels'
        type: string
        default: 'wheelhouse'
        required: false
      config-file:
        description: 'Path to cibuildwheel config file'
        type: string
        default: '{package}/pyproject.toml'
        required: false
      python-version:
        description: 'Python version for pure Python builds'
        type: string
        default: '3.11'
        required: false
      tag-pattern-release:
        description: 'Tag pattern for release builds'
        type: string
        default: 'release-v[0-9]+.[0-9]+.[0-9]+**'
        required: false
      tag-pattern-prerelease:
        description: 'Tag pattern for prerelease builds'
        type: string
        default: 'prerelease-v[0-9]+.[0-9]+.[0-9]+**'
        required: false
      create-release:
        description: 'Whether to create a GitHub release'
        type: boolean
        default: true
        required: false
      env:
        description: 'Environment variables in YAML format'
        type: string
        default: ''
        required: false
    secrets:
      gh-token:
        description: 'GitHub token for creating releases'
        required: false
jobs:
  check_release:
    name: Check for existing release
    runs-on: ubuntu-latest
    steps:
      - name: Check if non-draft release exists
        run: |
          # Extract version from tag
          TAG_NAME=${{ github.ref_name }}
          if [[ $TAG_NAME == release-v* ]]; then
            VERSION=${TAG_NAME#release-}
          elif [[ $TAG_NAME == prerelease-v* ]]; then
            VERSION=${TAG_NAME#prerelease-}
          else
            echo "Tag does not match expected patterns, skipping check"
            exit 0
          fi
          
          # Check for existing releases with this version
          echo "Checking for existing non-draft releases for version: $VERSION"
          
          # Get all releases and check for non-draft ones with matching version
          RELEASES=$(gh api repos/${{ github.repository }}/releases --paginate --jq '.[] | select(.draft == false) | .tag_name')
          
          for RELEASE in $RELEASES; do
            # Extract version from release tag
            RELEASE_VERSION=""
            if [[ $RELEASE == release-v* ]]; then
              RELEASE_VERSION=${RELEASE#release-}
            elif [[ $RELEASE == prerelease-v* ]]; then
              RELEASE_VERSION=${RELEASE#prerelease-}
            elif [[ $RELEASE == v* ]]; then
              RELEASE_VERSION=$RELEASE
            fi
            
            # Check if versions match
            if [[ "$RELEASE_VERSION" == "$VERSION" ]]; then
              echo "::error::Non-draft release already exists for version $VERSION (tag: $RELEASE)"
              exit 1
            fi
          done
          
          echo "No existing non-draft release found for version $VERSION"
        env:
          GH_TOKEN: ${{ secrets.gh-token || github.token }}
          
  build_wheels:
    name: ${{ inputs.pure-python && 'Build universal wheel' || format('Build wheels on {0}', matrix.os) }}
    needs: check_release
    runs-on: ${{ inputs.pure-python && 'ubuntu-latest' || matrix.os }}
    strategy:
      matrix:
        # For pure Python, only build once on ubuntu-latest
        # For compiled packages, build on multiple platforms
        os: ${{ inputs.pure-python && fromJSON('["ubuntu-latest"]') || fromJSON('["ubuntu-latest", "windows-latest", "macos-13", "macos-14", "ubuntu-24.04-arm"]') }}

    steps:
      - uses: actions/checkout@v4
      
      # Pure Python build path
      - name: Configure Python version
        if: ${{ inputs.pure-python }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ inputs.python-version }}
          architecture: x64
          
      - name: Set environment variables for pure Python build
        if: ${{ inputs.pure-python && inputs.env != '' }}
        shell: bash
        run: |
          # Parse YAML-formatted env vars and export them
          echo '${{ inputs.env }}' | while IFS= read -r line; do
            # Skip empty lines and comments
            if [[ -z "$line" ]] || [[ "$line" =~ ^[[:space:]]*# ]]; then
              continue
            fi
            
            # Extract key and value using parameter expansion
            if [[ "$line" =~ ^([^:]+):[[:space:]]*(.*)$ ]]; then
              key="${BASH_REMATCH[1]}"
              value="${BASH_REMATCH[2]}"
              
              # Trim whitespace from key
              key="${key// /}"
              
              # Remove leading/trailing quotes from value if present
              value="${value#\"}"
              value="${value%\"}"
              value="${value#\'}"
              value="${value%\'}"
              
              # Only set if key is not empty
              if [[ -n "$key" ]]; then
                echo "${key}=${value}" >> $GITHUB_ENV
                echo "::notice::Setting environment variable: ${key}=${value}"
              fi
            fi
          done
          
      - name: Build pure Python wheel
        if: ${{ inputs.pure-python }}
        run: |
          python -m pip install wheel
          python -m pip wheel ${{ inputs.package-dir }} -w ./${{ inputs.output-dir }}
      
      # Compiled package build path
      # aarch64 (arm) is built via qemu emulation
      # QEMU is sadly too slow. We need to wait for public ARM support
      #- name: Set up QEMU
      #  if: runner.os == 'Linux' && !inputs.pure-python
      #  uses: docker/setup-qemu-action@v3
      #  with:
      #    platforms: all
      - name: Parse environment variables
        if: ${{ !inputs.pure-python && inputs.env != '' }}
        id: parse-env
        shell: bash
        run: |
          # Parse YAML-formatted env vars and export them
          echo '${{ inputs.env }}' | while IFS= read -r line; do
            # Skip empty lines and comments
            if [[ -z "$line" ]] || [[ "$line" =~ ^[[:space:]]*# ]]; then
              continue
            fi
            
            # Extract key and value using parameter expansion
            if [[ "$line" =~ ^([^:]+):[[:space:]]*(.*)$ ]]; then
              key="${BASH_REMATCH[1]}"
              value="${BASH_REMATCH[2]}"
              
              # Trim whitespace from key
              key="${key// /}"
              
              # Remove leading/trailing quotes from value if present
              value="${value#\"}"
              value="${value%\"}"
              value="${value#\'}"
              value="${value%\'}"
              
              # Only set if key is not empty
              if [[ -n "$key" ]]; then
                echo "${key}=${value}" >> $GITHUB_ENV
                echo "::notice::Setting environment variable: ${key}=${value}"
              fi
            fi
          done
          
      - name: Build compiled wheels
        if: ${{ !inputs.pure-python }}
        uses: pypa/cibuildwheel@v3.2.1
        env:
          CIBW_ARCHS_LINUX: auto
        with:
          package-dir: ${{ inputs.package-dir }}
          output-dir: ${{ inputs.output-dir }}
          config-file: ${{ inputs.config-file }}
          
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.pure-python && 'cibw-wheel-pure' || format('cibw-wheels-{0}-{1}', matrix.os, strategy.job-index) }}
          path: ./${{ inputs.output-dir }}/${{ inputs.wheel-name-pattern }}

  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set environment variables for sdist
        if: ${{ inputs.env != '' }}
        shell: bash
        run: |
          # Parse YAML-formatted env vars and export them
          echo '${{ inputs.env }}' | while IFS= read -r line; do
            # Skip empty lines and comments
            if [[ -z "$line" ]] || [[ "$line" =~ ^[[:space:]]*# ]]; then
              continue
            fi
            
            # Extract key and value using parameter expansion
            if [[ "$line" =~ ^([^:]+):[[:space:]]*(.*)$ ]]; then
              key="${BASH_REMATCH[1]}"
              value="${BASH_REMATCH[2]}"
              
              # Trim whitespace from key
              key="${key// /}"
              
              # Remove leading/trailing quotes from value if present
              value="${value#\"}"
              value="${value%\"}"
              value="${value#\'}"
              value="${value%\'}"
              
              # Only set if key is not empty
              if [[ -n "$key" ]]; then
                echo "${key}=${value}" >> $GITHUB_ENV
                echo "::notice::Setting environment variable: ${key}=${value}"
              fi
            fi
          done
          
      - name: Build sdist
        run: pipx run build --sdist
      - uses: actions/upload-artifact@v4
        with:
          name: cibw-sdist
          path: dist/*.tar.gz
  create_release:
    if: ${{ inputs.create-release }}
    needs: [build_wheels, build_sdist]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Get the tag name and determine if it's a prerelease
        id: get_tag_info
        run: |
          FULL_TAG=${{ github.ref_name }}
          shopt -s extglob
          if [[ $FULL_TAG == release-v+([0-9]).+([0-9]).+([0-9])* ]]; then
            TAG_NAME=${FULL_TAG#release-}
            IS_PRERELEASE=false
          elif [[ $FULL_TAG == prerelease-v+([0-9]).+([0-9]).+([0-9])* ]]; then
            TAG_NAME=${FULL_TAG#prerelease-}
            IS_PRERELEASE=true
          else
            echo "Tag does not match expected patterns" >&2
            exit 1
          fi
          echo "FULL_TAG=$TAG_NAME" >> $GITHUB_ENV
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "IS_PRERELEASE=$IS_PRERELEASE" >> $GITHUB_ENV
      - uses: actions/download-artifact@v4
        with:
          # unpacks all CIBW artifacts into dist/
          pattern: cibw-*
          path: dist
          merge-multiple: true
      - name: Create Draft Release
        id: create_release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.gh-token || github.token }}
        with:
          repository: ${{ github.repository }}
          tag_name: ${{ github.ref_name }}
          name: ${{ env.TAG_NAME }}
          draft: true
          prerelease: ${{ env.IS_PRERELEASE }}
          files: "./dist/*" 
